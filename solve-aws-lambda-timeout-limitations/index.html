<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:137.5%/1.45 'georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:'georgia',serif;font-weight:normal;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;position:relative;left:50%;transform:translateX(-50%);}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell','Fira Sans','Droid Sans','Helvetica Neue',sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell','Fira Sans','Droid Sans','Helvetica Neue',sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell','Fira Sans','Droid Sans','Helvetica Neue',sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell','Fira Sans','Droid Sans','Helvetica Neue',sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell','Fira Sans','Droid Sans','Helvetica Neue',sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell','Fira Sans','Droid Sans','Helvetica Neue',sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}ul{margin-left:1.45rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.45rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;font-size:0.85rem;line-height:1.45rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}blockquote{margin-left:1.45rem;margin-right:1.45rem;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.45rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.45rem;}b{font-weight:bold;}strong{font-weight:bold;}dt{font-weight:bold;}th{font-weight:bold;}li{margin-bottom:calc(1.45rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.45rem;margin-bottom:calc(1.45rem / 2);margin-top:calc(1.45rem / 2);}li > ul{margin-left:1.45rem;margin-bottom:calc(1.45rem / 2);margin-top:calc(1.45rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.45rem / 2);}code{font-size:0.85rem;line-height:1.45rem;}kbd{font-size:0.85rem;line-height:1.45rem;}samp{font-size:0.85rem;line-height:1.45rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:0.96667rem;padding-right:0.96667rem;padding-top:0.725rem;padding-bottom:calc(0.725rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}a{color:#185D8B;}</style><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=929f256399e0a3cd849f69c9c307ba0f"/><style type="text/css">.gatsby-resp-image-image{width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;color:transparent;}</style><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><style data-href="/styles.e0efdd4ed935f7844814.css">code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.header{margin-bottom:1.45rem}.footer,.header{background:#36648b}.footer{padding-top:1.45rem}.header-heading{margin:0}.partial-layout{display:flex;justify-content:space-between;margin:0 auto;max-width:720px;padding:1.45rem 1.0875rem}.logo{color:#fff;text-decoration:none;text-shadow:none;background:none}.logo:hover{color:#fff;opacity:.8}.post-meta{color:#545454;display:flex;font-size:.8rem}.post-time{padding-left:0;text-transform:uppercase;white-space:nowrap}.post-timeToRead{font-size:.8rem;font-style:italic;margin-bottom:.4rem}.post-tags{display:flex;flex-wrap:wrap;list-style:none;margin:0 .8rem}.post-tag{color:#9eabb3;margin-right:.6rem;margin-bottom:.2rem}.post-tag a{color:#545454}.social-media{display:flex;list-style:none;margin-bottom:0;padding-bottom:1rem}.social-media li{margin-right:1rem}.social-media a{color:#fff}.main{margin:0 auto;max-width:720px;padding:1.25rem 1rem}.listing{list-style-type:none;margin-left:0}.listing a{text-decoration:none}.listing a h3:hover{text-decoration:underline}.listing a p{color:#000}.gatsby-resp-image-image{right:0;left:50%!important}</style><title data-react-helmet="true">Solve AWS Lambda timeout limitations | Kalin Chernev</title><meta data-react-helmet="true" name="description" content=""/><meta data-react-helmet="true" name="keywords" content=""/><meta data-react-helmet="true" charSet="utf-8"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1.0 shrink-to-fit=no"/><link rel="shortcut icon" href="/icons/icon-48x48.png?v=929f256399e0a3cd849f69c9c307ba0f"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#ffffff"/><meta name="generator" content="Gatsby 2.15.2"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=929f256399e0a3cd849f69c9c307ba0f"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=929f256399e0a3cd849f69c9c307ba0f"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=929f256399e0a3cd849f69c9c307ba0f"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=929f256399e0a3cd849f69c9c307ba0f"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=929f256399e0a3cd849f69c9c307ba0f"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=929f256399e0a3cd849f69c9c307ba0f"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=929f256399e0a3cd849f69c9c307ba0f"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link as="script" rel="preload" href="/component---src-templates-post-jsx-c39df2b265e427ce0053.js"/><link as="script" rel="preload" href="/styles-985070f79ff12a32628c.js"/><link as="script" rel="preload" href="/app-14428d4cab047b80fe09.js"/><link as="script" rel="preload" href="/commons-d91aa4dbb2b8d5cb3880.js"/><link as="script" rel="preload" href="/webpack-runtime-27e78835e64fb47c196c.js"/><link as="fetch" rel="preload" href="/page-data/solve-aws-lambda-timeout-limitations/page-data.json" crossorigin="anonymous"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div class="header"><div class="partial-layout"><h1 class="header-heading"><a class="logo" href="/">Kalin Chernev</a></h1></div></div><div class="main"><section class="post-meta"><time class="post-time" dateTime="2018-10-25T22:00:00.000Z">Friday, October 26, 2018</time><ul class="post-tags"><li class="post-tag"><a title="Click here to see all posts about aws" href="/tags/aws">#<!-- -->AWS</a></li><li class="post-tag"><a title="Click here to see all posts about serverless" href="/tags/serverless">#<!-- -->Serverless</a></li><li class="post-tag"><a title="Click here to see all posts about docker" href="/tags/docker">#<!-- -->Docker</a></li><li class="post-tag"><a title="Click here to see all posts about ecs" href="/tags/ecs">#<!-- -->ECS</a></li><li class="post-tag"><a title="Click here to see all posts about javascript" href="/tags/javascript">#<!-- -->JavaScript</a></li></ul></section><div class="post-timeToRead">Approximately <!-- -->6<!-- --> minutes to read ...</div><h1>Solve AWS Lambda timeout limitations</h1><div><p>As I've been drafting a strategy to <a href="/solving-aws-lambda-timeouts-fargate">solve the AWS Lambda timeout limitations</a> I felt I'm getting closer to solving an issue which keeps me away from sleeping well sometimes. True that there are known patterns for <a href="https://www.jeremydaly.com/serverless-microservice-patterns-for-aws/">reaching higher scalability using SQS</a> though the problems at hand were not easy to solve with either of those when the AWS Lambda is used as a core compute service.</p>
<p>During the same period of me focusing on the timeout limitations issue, <a href="https://aws.amazon.com/about-aws/whats-new/2018/10/aws-lambda-supports-functions-that-can-run-up-to-15-minutes/">AWS raised the limit to 15 minutes</a>. Although this is surely a useful change, I still preferred to polish my draft strategy of using a non-lambda compute which will not have a limit at all. When the safety-net-compute is also based on a per-demand pricing model, this forms a real solution to the problem. In reality, sometimes it's impossible to predict load up front and maxing out limits is not the ultimate solution.</p>
<h2 id="notable-improvements"><a href="#notable-improvements" aria-label="notable improvements permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Notable improvements</h2>
<p>Here's a short overview of the most important improvements I've made between draft implementation and current one:</p>
<ul>
<li><a href="https://www.npmjs.com/package/unzip">unzip</a> has been swapped to <a href="https://www.npmjs.com/package/unzipper">unzipper</a> for a <a href="https://github.com/EvanOxfeld/node-unzip/issues/120">good reason</a>. API is same.</li>
<li>Logic gluing primary and secondary lambda handlers has been changed. Instead of using naming conventions which are an easy to mistake constraint, I've put in place a mapping "cheatsheet".</li>
<li><a href="https://github.com/gmetzker/serverless-plugin-lambda-dead-letter">serverless-plugin-lambda-dead-letter</a> dependency, which looked promising, was removed in favour of native functionalities of CloudFormation. Main reason: <a href="https://github.com/gmetzker/serverless-plugin-lambda-dead-letter/issues/37">issues with intrinsic functions</a>.</li>
<li><code class="language-text">event</code> and <code class="language-text">context</code> from primary handler have been moved to environment variables passed through <a href="https://docs.aws.amazon.com/AmazonECS/latest/APIReference/API_ContainerOverride.html">ContainerOverride</a> API because information from original JSON objects was getting dropped during the process of executing <a href="https://docs.aws.amazon.com/AmazonECS/latest/APIReference/API_RunTask.html">runTask</a>. This is also an improvement in terms of consistency of managing environment variables.</li>
<li>Use original environment variables from primary handler through the same <a href="https://docs.aws.amazon.com/lambda/latest/dg/API_GetFunction.html">GetFunction</a> which yields this <a href="https://docs.aws.amazon.com/lambda/latest/dg/API_EnvironmentResponse.html?shortFooter=true">configuration</a> together with the location of the source of the primary handler already fetched.</li>
<li>A helper to handle varying <code class="language-text">event</code> structures has been added. Appears that an SNS event changes from a bucket to bucket depending on the way files are managed within bucket.</li>
</ul>
<p>Skeleton of the end implementation can be seen in this <a href="https://github.com/kalinchernev/immortal-aws-lambda">repository</a>.</p>
<h2 id="implementation"><a href="#implementation" aria-label="implementation permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Implementation</h2>
<p>So how does the current implementation look like after the before-mentioned improvements?</p>
<p>From a bird's-eye view, structure and main ideas are the same:</p>
<div class="gatsby-highlight" data-language="sh"><pre class="language-sh"><code class="language-sh">immortal-aws-lambda
├── container
│   ├── Dockerfile
│   ├── package.json
│   ├── README.md
│   └── runner.js
└── serverless
    ├── package.json
    ├── README.md
    ├── serverless.yml
    ├── src
    │   ├── events
    │   │   └── onFailure.js
    │   └── lib
    │       ├── extractors.js
    │       ├── getHandlerData.js
    │       └── snsTopicToHandlerMap.js
    └── webpack.config.js

5 directories, 12 files</code></pre></div>
<h3 id="immortal-aws-lambda-container-service"><a href="#immortal-aws-lambda-container-service" aria-label="immortal aws lambda container service permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a href="https://github.com/kalinchernev/immortal-aws-lambda/tree/master/container">Immortal AWS Lambda: Container Service</a></h3>
<p>Probably you'll want to create the ECS task in AWS console first and take some settings you'll need for the serverless service.</p>
<p>The sole goal of this service is to put a <code class="language-text">runner.js</code> script in a container and run it remotely from the dead letter queue service.</p>
<p>The contents of the script is actually ultra-thin and is comprised of 3 main steps:</p>
<ol>
<li>Take initial source code of a lambda handler</li>
<li>Take environment variables of the same handler</li>
<li>Run the handler</li>
</ol>
<p>All settings are dynamic variables.</p>
<p>And the source is ultra-simple:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node

<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">AWS</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'aws-sdk'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> promisePipe <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'promisepipe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> unzip <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'unzipper'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">runner</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token constant">REGION</span><span class="token punctuation">,</span>
    <span class="token constant">AWS_LAMBDA_HANDLER_EVENT</span><span class="token punctuation">,</span>
    <span class="token constant">AWS_LAMBDA_HANDLER_CONTEXT</span><span class="token punctuation">,</span>
    <span class="token constant">AWS_LAMBDA_HANDLER_NAME</span><span class="token punctuation">,</span>
    <span class="token constant">AWS_LAMBDA_HANDLER_PATH</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> event <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">AWS_LAMBDA_HANDLER_EVENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">AWS_LAMBDA_HANDLER_CONTEXT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> lambda <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AWS<span class="token punctuation">.</span>Lambda</span><span class="token punctuation">(</span><span class="token punctuation">{</span> region<span class="token punctuation">:</span> <span class="token constant">REGION</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> lambdaInfo <span class="token operator">=</span> <span class="token keyword">await</span> lambda
      <span class="token punctuation">.</span><span class="token function">getFunction</span><span class="token punctuation">(</span><span class="token punctuation">{</span> FunctionName<span class="token punctuation">:</span> <span class="token constant">AWS_LAMBDA_HANDLER_NAME</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> sourceCodeSignedUrl <span class="token operator">=</span> lambdaInfo<span class="token punctuation">.</span>Code<span class="token punctuation">.</span>Location<span class="token punctuation">;</span>

    <span class="token keyword">return</span> https<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sourceCodeSignedUrl<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">res</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// Download source from cloud and extract it at the current directory at the same time.</span>
      <span class="token keyword">await</span> <span class="token function">promisePipe</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> unzip<span class="token punctuation">.</span><span class="token function">Extract</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token punctuation">:</span> __dirname <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> pathToHandler <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">AWS_LAMBDA_HANDLER_PATH</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// eslint-disable-next-line</span>
      <span class="token keyword">const</span> handler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>pathToHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Merge environment variables.</span>
      process<span class="token punctuation">.</span>env <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        process<span class="token punctuation">.</span>env<span class="token punctuation">,</span>
        lambdaInfo<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span>Environment<span class="token punctuation">.</span>Variables
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> handler<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">runner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h3 id="immortal-aws-lambda-serverless-service"><a href="#immortal-aws-lambda-serverless-service" aria-label="immortal aws lambda serverless service permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a href="https://github.com/kalinchernev/immortal-aws-lambda/tree/master/serverless">Immortal AWS Lambda: Serverless Service</a></h3>
<p>This is the serverless service to deploy. It's as simple and independent as it could be:</p>
<ul>
<li>Provides a dead letter queue <code class="language-text">LambdaFailureQueue</code> to which others can push messages when failing.</li>
<li>Exports the ARN of the queue in order for other services to be able to import the value of the ARN. (<a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/outputs-section-structure.html">docs</a>)</li>
<li>All the other details about the <code class="language-text">iamRoleStatements</code>, <code class="language-text">events</code> subscriptions and settings remain the same as before.</li>
</ul>
<p>Helpers in <code class="language-text">lib</code> are your responsibility to implement as <code class="language-text">event</code> structures in your case will be different. (most probably)</p>
<p>Still, the main point of having this service is still to run an ECS task starting a container:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> runParams <span class="token operator">=</span> <span class="token punctuation">{</span>
  taskDefinition<span class="token punctuation">:</span> <span class="token constant">RUNNER</span><span class="token punctuation">,</span>
  launchType<span class="token punctuation">:</span> <span class="token string">"FARGATE"</span><span class="token punctuation">,</span>
  networkConfiguration<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    awsvpcConfiguration<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      assignPublicIp<span class="token punctuation">:</span> <span class="token string">"ENABLED"</span><span class="token punctuation">,</span>
      subnets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token constant">SUBNET</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  overrides<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    containerOverrides<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        environment<span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"AWS_LAMBDA_HANDLER_EVENT"</span><span class="token punctuation">,</span>
            value<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>initialMessage<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"AWS_LAMBDA_HANDLER_CONTEXT"</span><span class="token punctuation">,</span>
            value<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"AWS_LAMBDA_HANDLER_NAME"</span><span class="token punctuation">,</span>
            value<span class="token punctuation">:</span> handlerData<span class="token punctuation">.</span>name
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">"AWS_LAMBDA_HANDLER_PATH"</span><span class="token punctuation">,</span>
            value<span class="token punctuation">:</span> handlerData<span class="token punctuation">.</span>path
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        name<span class="token punctuation">:</span> <span class="token constant">RUNNER</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> ecs<span class="token punctuation">.</span><span class="token function">runTask</span><span class="token punctuation">(</span>runParams<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Don't forget to take these settings from the AWS Console and set them in your <code class="language-text">serverless.yaml</code> configuration file.</p>
<h3 id="integrating-services-in-the-workflow"><a href="#integrating-services-in-the-workflow" aria-label="integrating services in the workflow permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Integrating services in the workflow</h3>
<p>"Attaching" other serverless services and handlers to this workflow boils down the following:</p>
<ol>
<li>Allow the service to push messages to the SQS dead letter queue:</li>
</ol>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">iamRoleStatements</span><span class="token punctuation">:</span>
  <span class="token comment"># Allow queueing messages to the DLQ https://docs.aws.amazon.com/lambda/latest/dg/dlq.html</span>
  <span class="token punctuation">-</span> <span class="token key atrule">Effect</span><span class="token punctuation">:</span> <span class="token string">'Allow'</span>
    <span class="token key atrule">Action</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> sqs<span class="token punctuation">:</span>SendMessage
    <span class="token key atrule">Resource</span><span class="token punctuation">:</span> <span class="token string">'*'</span></code></pre></div>
<ol start="2">
<li>Add ARN information about the SQS queue from <code class="language-text">Resources</code> section</li>
</ol>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token key atrule">Resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">fooFunction</span><span class="token punctuation">:</span>
      <span class="token key atrule">Type</span><span class="token punctuation">:</span> <span class="token string">"AWS::Lambda::Function"</span>
      <span class="token key atrule">Properties</span><span class="token punctuation">:</span>
        <span class="token key atrule">DeadLetterConfig</span><span class="token punctuation">:</span>
          <span class="token key atrule">TargetArn</span><span class="token punctuation">:</span>
            <span class="token key atrule">Fn::ImportValue</span><span class="token punctuation">:</span> immortal<span class="token punctuation">-</span>aws<span class="token punctuation">-</span>lambda<span class="token punctuation">:</span>LambdaFailureQueue</code></pre></div>
<p>This is because the serverless framework does not yet support <a href="https://www.trek10.com/blog/dead-letter-config/"><code class="language-text">onError</code></a> properly. Thanks to <a href="https://github.com/neowulf">Siva Kommuri</a> for <a href="https://github.com/neowulf">suggesting this workaround</a>.</p>
<p>Now, when your service fails, the error will be queued to the dead letter queue provided by the immortal aws lambda service, the immortal service will take this message, find the right handler and call it via the container service.</p>
<h2 id="final-thoughts"><a href="#final-thoughts" aria-label="final thoughts permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Final thoughts</h2>
<p>My path to finding this solution was not easy.</p>
<p>The tools involved are having rough edges.</p>
<p>Also, the process of triggering and reproducing failures because of a timeout, rebuilding the container, etc. is a lenghtly procedure on each iteration. For instance, every time something fails because of a missing character or spelling mistake, I needed to redeploy the non-bundles and non-optimized code of the lambda function to the cloud in order to get merely adequate error message for debugging in the logs of the ECS. (crazy!)</p>
<p>Working with streams and promises in Node is still very painful and hard to debug by the way ...</p>
<p>So I hope that having these very thin layers of variables which communicate to each other will be a feasible solution for solving the timeout limitations in AWS Lambda for months ahead.</p></div></div><div class="footer"><div class="partial-layout"><ul class="social-media"><li><a title="Link to a LinkedIn profile" href="https://www.linkedin.com/in/kalinchernev/">LinkedIn</a></li><li><a title="Link to a Github profile" href="https://github.com/kalinchernev">Github</a></li><li><a title="Link to a Twitter profile" href="https://twitter.com/kalinchernev">Twitter</a></li></ul></div></div></div></div><script>
  
  function gaOptout(){document.cookie=disableStr+'=true; expires=Thu, 31 Dec 2099 23:59:59 UTC;path=/',window[disableStr]=!0}var gaProperty='UA-97001925-1',disableStr='ga-disable-'+gaProperty;document.cookie.indexOf(disableStr+'=true')>-1&&(window[disableStr]=!0);
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-97001925-1', 'auto', {});
      ga('set', 'anonymizeIp', true);
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/solve-aws-lambda-timeout-limitations";window.webpackCompilationHash="628be610361b8553fe21";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-14428d4cab047b80fe09.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-2c5b052afb4fb7b8b1dc.js"],"component---src-templates-post-jsx":["/component---src-templates-post-jsx-c39df2b265e427ce0053.js"],"component---src-templates-post-list-jsx":["/component---src-templates-post-list-jsx-fbc57f6728adca243847.js"],"component---src-templates-tags-jsx":["/component---src-templates-tags-jsx-47bd1872810d67250546.js"],"component---src-pages-404-jsx":["/component---src-pages-404-jsx-e34ffac2a57942b5624d.js"],"component---src-pages-index-jsx":["/component---src-pages-index-jsx-ef85e0a3e314407f2d85.js"]};/*]]>*/</script><script src="/webpack-runtime-27e78835e64fb47c196c.js" async=""></script><script src="/commons-d91aa4dbb2b8d5cb3880.js" async=""></script><script src="/app-14428d4cab047b80fe09.js" async=""></script><script src="/styles-985070f79ff12a32628c.js" async=""></script><script src="/component---src-templates-post-jsx-c39df2b265e427ce0053.js" async=""></script></body></html>