{"componentChunkName":"component---src-templates-post-template-post-template-tsx","path":"/serverless-github-bot-aws-lambda-api-gateway-nodejs","result":{"data":{"markdownRemark":{"id":"756e569e-c407-5cfc-9244-f169237cd8b9","html":"<p>This tutorial will show you how to build a small github bot app which is “listening” for pull requests’ events on “open” and “reopen” by <a href=\"https://greenkeeper.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">greenkeeper.io</a>. When the author is the greenkeeper bot, our bot will in turn, correct the title and the tags of the pull request to match conventions.</p>\n<p><img src=\"/media/github_bot_correcting_greenkeeper-1.png\" alt=\"Github bot correcting the greenkeeper bot\"></p>\n<p>If you’ve come to this article because you already have knowledge about the technical topics, but you are more interested in the concrete steps, you can skip the following introductory parts and go directly to the technical specifics below. To go to the technical details scroll down to the <strong>“10 steps to make it happen”</strong> section ;)</p>\n<p>The script will actually be pretty small and simple, though there are quite some interesting ideas you might get on the way.</p>\n<h2 id=\"serverless\" style=\"position:relative;\"><a href=\"#serverless\" aria-label=\"serverless permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Serverless</h2>\n<p><a href=\"https://en.wikipedia.org/wiki/Serverless_computing\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Serverless computing</a> is a relatively new trend which is getting greater popularity after Amazon released their <a href=\"https://aws.amazon.com/lambda/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">AWS Lambda</a> service in the end of 2014. I published about this topic in a bit <a href=\"/january-digest-2017/#cloud\">more details earlier this year</a>. In one sentence, serverless architectures (aka cloud functions) are getting traction in cases where high-level architecture control is sufficient for developers who delegate the details about the infrastructure management to a hidden underlying layer managed by a cloud provider.</p>\n<p>In addition to the low maintenance efforts, pricing per resource is also a lucrative opportunity for app developers - at the moment 1 million requests to AWS Lambda are <a href=\"https://aws.amazon.com/free/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">free</a> - this is generous! Later, <a href=\"https://aws.amazon.com/lambda/pricing/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">pricing</a> continues to be calculated based on actual usage. This means that applications cost money when they actually compute. That’s good for both up-scaling and down-scaling.</p>\n<p>Here’s a graphic from <a href=\"https://acloud.guru/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">acloud.guru</a> which explains this evolution step in simple terms, I think:</p>\n<p><img src=\"/media/brief-history-of-cloud-acloud-guru.png\" alt=\"Where is the serverless in the history of the cloud\"></p>\n<p>Lastly, cloud functions such as AWS Lambda come well into play in event-oriented designs. Here’s a simplified list of some <a href=\"http://docs.aws.amazon.com/lambda/latest/dg/use-cases.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">official use cases</a>:</p>\n<ul>\n<li>\n<p>event-driven services where the cloud function is run in response to other events - usually triggered by AWS S3, SNS, DynamoDB, etc.</p>\n</li>\n<li>\n<p>services responding to HTTP requests - triggered by Amazon API Gateway or other AWS clients.</p>\n</li>\n</ul>\n<p>A github bot app can be considered as a service from the second set of scenarios. The end result is an API endpoint responding to <code class=\"language-text\">POST</code> requests (events) from <a href=\"https://developer.github.com/webhooks/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">github webhooks</a>.</p>\n<h2 id=\"notes-on-the-aws-serverless-stack\" style=\"position:relative;\"><a href=\"#notes-on-the-aws-serverless-stack\" aria-label=\"notes on the aws serverless stack permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Notes on the AWS serverless stack</h2>\n<p>Watching videos and reading tutorials on the topic can get you pretty excited. Here are some notes about steps which didn’t go totally smooth during my journey, i.e. I want to prepare you for the reality before you get frustrated ;)</p>\n<p><strong>1) The AWS services ain’t that easy, especially if you’re relatively new to AWS in overall</strong></p>\n<p>For example:</p>\n<ul>\n<li>\n<p><a href=\"https://aws.amazon.com/documentation/lambda/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">AWS Lambda developer guide</a> - 300+ pages</p>\n</li>\n<li>\n<p><a href=\"https://aws.amazon.com/documentation/apigateway/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Amazon API Gateway developer guide</a> - 450+ pages</p>\n</li>\n<li>\n<p><a href=\"https://aws.amazon.com/documentation/iam/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">IAM documentation</a> - I don’t even want to check …</p>\n</li>\n</ul>\n<p>In short - there’s a lot of information and you have to find your way through the important parts which will help you in the specific case.</p>\n<p>For our case in this tutorial, let’s assume we can follow the getting started guide and build a simple cloud function working behind an <a href=\"http://docs.aws.amazon.com/apigateway/latest/developerguide/getting-started.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">API gateway endpoint</a>. If you want to do it right, you will have to have an idea about concepts such as: <a href=\"http://docs.aws.amazon.com/apigateway/latest/developerguide/request-response-data-mappings.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">mapping request and response data</a>, getting to know some new <a href=\"http://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-mapping-template-reference.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">template language for mapping variables</a>, etc. These are the basics of API Gateway to get you going with the request and response management. Then come some fundamentals you’ll need about the AWS Lambda too - knowing what is a <a href=\"http://docs.aws.amazon.com/lambda/latest/dg/nodejs-prog-model-handler.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">handler function</a> (the cloud function), figure <a href=\"http://docs.aws.amazon.com/lambda/latest/dg/nodejs-prog-model-context.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">the parameters of the handler</a> and <a href=\"http://docs.aws.amazon.com/lambda/latest/dg/nodejs-prog-model-logging.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">reading logs</a> from another AWS service.</p>\n<p>In short, “keep calm and learn AWS services”, at least the basics.</p>\n<p><strong>2) We speak cloud abstraction here - it is not easily reproducible for local development</strong></p>\n<p>I spent quite some time researching on ways to have the whole AWS API Gateway + AWS Lambda setup locally so that I can start hacking quickly on my computer, but I haven’t found anything so far. If you have one or some in mind - please tell me!</p>\n<p><strong>3) We still write JavaScript and Node.js - be ready for the regular hurdles you’ll normally have</strong></p>\n<p>The fact that you’re delegating the infrastructure complexity to someone else out there doesn’t mean that your code will automagically work, at least not in the Node.js world, not at the moment.</p>\n<p>For example, sometimes you would receive errors <a href=\"https://forums.aws.amazon.com/thread.jspa?threadID=229528\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">like this</a> and you will have to apply your JavaScript knowledge and patience to switch between versions of Node, transpile the code for the Lambda to be able to show you useful error messages …</p>\n<p>For me, the <a href=\"https://serverless.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">serverless</a> framework worked pretty well in the deployment part. It definitely hid most of the complexity of understanding template languages and setting up boilerplate code for the function to work.</p>\n<h2 id=\"notes-on-the-serverless-framework\" style=\"position:relative;\"><a href=\"#notes-on-the-serverless-framework\" aria-label=\"notes on the serverless framework permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Notes on the <a href=\"https://serverless.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">serverless</a> framework</h2>\n<p>If you, like me, feel that the setup of the framework is a bit too much, then just go directly to the <a href=\"https://github.com/serverless/examples\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">example repository</a> and get to know the <a href=\"https://github.com/serverless/examples/tree/master/aws-node-github-webhook-listener\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">aws-node-github-webhook-listener</a>.</p>\n<p>By using this example boilerplate, you will need only 2 keys auth components to make the communication between services work:</p>\n<ul>\n<li>\n<p><a href=\"https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Github user token</a></p>\n</li>\n<li>\n<p><a href=\"http://docs.aws.amazon.com/general/latest/gr/managing-aws-access-keys.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">AWS user tokens</a></p>\n</li>\n</ul>\n<p>Try to keep the scope of permissions to a minimum to ensure best security in your applications. Both AWS and serverless provide other authentication options you might feel more comfortable with.</p>\n<h2 id=\"notes-on-the-github-part\" style=\"position:relative;\"><a href=\"#notes-on-the-github-part\" aria-label=\"notes on the github part permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Notes on the github part</h2>\n<p>The setup on github is simpler than AWS. Basically, you’ll need to read about <a href=\"https://developer.github.com/webhooks/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">webhooks</a>. The documentation is without a doubt - great - it walks you through all the stages from setting up a local dev environment, testing a hook, and also having a good knowledge of the structure of the webhooks’ payloads.</p>\n<p>This is a high-level action plan:</p>\n<ul>\n<li>\n<p>Have an account, a repo, etc.</p>\n</li>\n<li>\n<p>Generate a user token. (<a href=\"https://help.github.com/articles/differences-between-user-and-organization-accounts/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">user can be a bot</a>)</p>\n</li>\n<li>\n<p>Setup webhooks for a repository.</p>\n</li>\n<li>\n<p>Enter information about the API Gateway endpoint which works with the cloud function, this is your bot.</p>\n</li>\n</ul>\n<h2 id=\"10-steps-to-make-it-happen\" style=\"position:relative;\"><a href=\"#10-steps-to-make-it-happen\" aria-label=\"10 steps to make it happen permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>10 steps to make it happen</h2>\n<p>Ok, enough introductory talks, that’s the more visual part of the article containing the main milestones making the things actually work.</p>\n<p><strong>1. Create a user that can work with AWS Lambda and API Gateway services.</strong></p>\n<p><img src=\"/media/create_aws_user_lambda.gif\" alt=\"Creating an AWS user you can operate with\"></p>\n<p>For simplicity, I’m adding the user to the group of admins. Then I’m downloading the tokens for later use with the serverless framework.</p>\n<p><strong>2. Go to your github profile settings page and <a href=\"https://github.com/settings/tokens/new\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">generate a user token</a> by which the bot will act on your behalf.</strong></p>\n<p>You can make a cool bot separate from your account, of course.</p>\n<p><img src=\"/media/new_user_token_github.png\" alt=\"Creating a new user token on github.com\"></p>\n<p>When you save this form, you will see the token, which you have to save somewhere with the same attention you would have to your password:</p>\n<p><strong>3. <a href=\"https://developer.github.com/webhooks/securing\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Generate a webhook secret</a></strong></p>\n<p><img src=\"/media/generate_webhook_secret-1.png\" alt=\"Generating a webhook on github.com\"></p>\n<p><strong>4. Input the user token and the webhook secret in the serverless config file</strong></p>\n<p><img src=\"/media/save_config.png\" alt=\"Saving configurations in the serverless framework config file\"></p>\n<p><strong>5. Put function code in the <code class=\"language-text\">handler.js</code> file</strong></p>\n<p><img src=\"/media/handler.png\" alt=\"Editing the cloud function\"></p>\n<p><strong>6. You can try to deploy the function:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ serverless deploy\n</code></pre></div>\n<p>Watch it fail ;)</p>\n<p><img src=\"/media/enter_credentials_serverless.png\" alt=\"Failing deployment in the serverless framework\"></p>\n<p><strong>7. Export your keys (which you downloaded in the <code class=\"language-text\">credentials.csv</code> files earlier as:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ export AWS_ACCESS_KEY_ID=\n$ export AWS_SECRET_ACCESS_KEY=\n# AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY are now available for serverless to use\nserverless deploy\n</code></pre></div>\n<p><strong>8. Run <code class=\"language-text\">serverless deploy</code> again and watch it succeeding</strong></p>\n<p><img src=\"/media/serverless_deploy_success.gif\" alt=\"Showing a successful deployment of a function on AWS\"></p>\n<p><strong>9. Take the provided URL and add it to the webhooks of your repository where you want the bot to take effect</strong></p>\n<p><img src=\"/media/adding_webhook_github.png\" alt=\"Adding a new webhook on github.com\"></p>\n<p>Few notes:</p>\n<ul>\n<li>\n<p>This is the secret you previously generated via the command line</p>\n</li>\n<li>\n<p>It’s a good practice to filter only the necessary events in order to minimize the load to the endpoint</p>\n</li>\n</ul>\n<p><strong>10. Trigger the webhook either by github or by closing and re-opening an existing pull request which has been opened by greenkeeper bot.</strong></p>\n<p>That’s an <a href=\"https://gist.github.com/kalinchernev/d1e79a7f883a4d37f50519d9b05df0c5.js\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">example script</a> you can use.</p>\n<h2 id=\"extras\" style=\"position:relative;\"><a href=\"#extras\" aria-label=\"extras permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Extras</h2>\n<p>When you have this automated corrections on pull request titles and tags, you might also need to <a href=\"https://github.com/greenkeeperio/greenkeeper-lockfile\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">update the lock files</a> of the pull request to make all ready for merging.</p>","fields":{"slug":"/posts/serverless-github-bot-aws-lambda-and-api-gateway//serverless-github-bot-aws-lambda-api-gateway-nodejs","tagSlugs":["/tag/bots/","/tag/nodejs/","/tag/javascript/","/tag/serverless/","/tag/aws/"]},"frontmatter":{"date":"2017-07-11T22:40:00.000Z","description":null,"tags":["Bots","nodejs","JavaScript","Serverless","AWS"],"title":"Serverless github bot with AWS Lambda and API Gateway","socialImage":{"publicURL":"/static/0249a8579cfb4088acaf23fcac068444/defaultSocialImage.jpg"}}}},"pageContext":{"slug":"/posts/serverless-github-bot-aws-lambda-and-api-gateway//serverless-github-bot-aws-lambda-api-gateway-nodejs"}},"staticQueryHashes":["251939775","2764776372","401334301"]}