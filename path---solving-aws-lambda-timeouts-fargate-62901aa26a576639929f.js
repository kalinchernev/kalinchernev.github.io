webpackJsonp([0xc4449ff03a59],{566:function(n,a){n.exports={data:{markdownRemark:{frontmatter:{title:"Solving the AWS Lambda timeout limitation with Amazon ECS Fargate",date:"2018-09-02T22:00:00.000Z",tags:["AWS","Serverless","Docker","ECS","JavaScript"]},timeToRead:8,html:'<p>Recently, I read an article about <a href="https://serverless.com/blog/serverless-application-for-long-running-process-fargate-lambda">using Fargate for long-running processes</a>. The article explains the fundamentals well, though in my view it\'s not touching upon a few important details I expected to see. So in this article I\'ll build upon this article and reflect on some possible tweaks.</p>\n<p>The next ideas will be demonstrated with Node.js, though any other runtime would work just as fine. In the end, the background APIs used are same - AWS\'s Lambda, ECS, etc.</p>\n<h2 id="reflections"><a href="#reflections" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Reflections</h2>\n<p>For me, the main point of reading the article about the long-running processes was to see details about solving the 5 minutes limitation in AWS Lambda, similar to this <a href="https://serifandsemaphore.io/aws-lambda-going-beyond-5-minutes-34e381e71231">older one</a>. Instead, it was focused on the ECS setup and there wasn\'t much about the integration reasoning. Also, the examples of <a href="https://docs.aws.amazon.com/AmazonECS/latest/APIReference/API_RunTask.html">runTask</a> was a useful start, though it\'s not immediately obvious how the environment variables can act as dynamic parameters. Last, but not least, reading around the topic of integrating AWS Lambda with ECS Fargate, I was surprised <a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/Lambda.html#getFunction-property">getFunction</a> wasn\'t used in any of the implementations. (At least I didn\'t find one) This function returns an address to a signed URL holding a zip archive to a given lambda handler. This handler is the code which could be executed in the container. In my opinion, that information and resource would enable a far thinner implementation approach in the container.</p>\n<p>Keep in mind that with <a href="https://github.com/serverless-heaven/serverless-webpack">serverless-webpack</a> you can package your handlers, libraries and others into a single file cotaining all dependencies.</p>\n<h2 id="ideas-about-implementation"><a href="#ideas-about-implementation" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Ideas about implementation</h2>\n<p>After the above-mentioned research and reflections, I came to the following ideas about possible implementation strategy:</p>\n<ul>\n<li>Have the primary AWS Lambda handler. This is the business critical handler which should not fail because of timeout limitations</li>\n<li>Have a secondary AWS Lambda handler which is plugged to the primary via a <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-dead-letter-queues.html">dead letter queue</a>. Not only <a href="https://aws.amazon.com/blogs/aws/aws-lambda-adds-amazon-simple-queue-service-to-supported-event-sources/">SQS is a valid trigger nowadays</a> but it\'s also better to start the Fargate service only and if it\'s necessary. More specifically, the <a href="https://docs.aws.amazon.com/lambda/latest/dg/retries-on-errors.html">retry behavior</a> in case of timeout will try to re-run the handler 3 times. If 3 attempts fail, then and only then the secondary handler being a safety net will trigger the container for a long-running task.</li>\n<li>Run the ECS Fargate Docker container when primary handler fails. The container\'s wrapper around the primary handler should be as thin as fetching original handler and passing down the original <code class="language-text">event</code> and <code class="language-text">context</code> without any mutations.</li>\n</ul>\n<h2 id="implementation-notes"><a href="#implementation-notes" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Implementation notes</h2>\n<h3 id="update-the-code-classlanguage-textserverlesscode-service"><a href="#update-the-code-classlanguage-textserverlesscode-service" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Update the <code class="language-text">serverless</code> service</h3>\n<p>Because services are based on the <code class="language-text">serverless</code> framework, I used <a href="https://www.npmjs.com/package/serverless-plugin-lambda-dead-letter">this dead letter queue plugin</a> in order to attach the secondary handler to the primary one.</p>\n<p>This means that, inside your <code class="language-text">serverless.yaml</code> file:</p>\n<ol>\n<li>Enable the DLQ plugin</li>\n</ol>\n<div class="gatsby-highlight" data-language="yaml">\n      <pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">plugins</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> serverless<span class="token punctuation">-</span>plugin<span class="token punctuation">-</span>lambda<span class="token punctuation">-</span>dead<span class="token punctuation">-</span>letter</code></pre>\n      </div>\n<ol start="2">\n<li>Create the dead letter queue in <code class="language-text">Resources</code></li>\n</ol>\n<div class="gatsby-highlight" data-language="yaml">\n      <pre class="language-yaml"><code class="language-yaml">    <span class="token key atrule">SQSFailureQueue</span><span class="token punctuation">:</span>\n      <span class="token key atrule">Type</span><span class="token punctuation">:</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>SQS<span class="token punctuation">:</span><span class="token punctuation">:</span>Queue\n      <span class="token key atrule">Properties</span><span class="token punctuation">:</span>\n        <span class="token key atrule">QueueName</span><span class="token punctuation">:</span> sqs<span class="token punctuation">-</span>failure<span class="token punctuation">-</span>queue\n        <span class="token key atrule">MessageRetentionPeriod</span><span class="token punctuation">:</span> <span class="token string">\'1209600\'</span>\n        <span class="token key atrule">VisibilityTimeout</span><span class="token punctuation">:</span> <span class="token string">\'60\'</span></code></pre>\n      </div>\n<p>If you haven\'t created this section yet, follow the <a href="https://serverless.com/framework/docs/providers/aws/guide/resources/">documentation</a>.</p>\n<ol start="3">\n<li>Attach the secondary handler to the SQS queue:</li>\n</ol>\n<div class="gatsby-highlight" data-language="yaml">\n      <pre class="language-yaml"><code class="language-yaml">  <span class="token key atrule">secondaryHandler</span><span class="token punctuation">:</span>\n    <span class="token key atrule">handler</span><span class="token punctuation">:</span> path/to/immortal<span class="token punctuation">-</span>handlerDlq.handler\n    <span class="token key atrule">name</span><span class="token punctuation">:</span> immortal<span class="token punctuation">-</span>handlerDql\n    <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n      <span class="token key atrule">REGION</span><span class="token punctuation">:</span> eu<span class="token punctuation">-</span>west<span class="token punctuation">-</span><span class="token number">1</span>\n      <span class="token comment"># ECS task to execute handler without timeout limitations</span>\n      <span class="token key atrule">RUNNER</span><span class="token punctuation">:</span> runner\n      <span class="token comment"># Required for runTask API call, preliminary created on AWS.</span>\n      <span class="token key atrule">SUBNET</span><span class="token punctuation">:</span> subnet<span class="token punctuation">-</span>xxxxxxxx\n      <span class="token punctuation">...</span>\n    <span class="token key atrule">events</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token key atrule">sqs</span><span class="token punctuation">:</span>\n          <span class="token key atrule">arn</span><span class="token punctuation">:</span>\n            <span class="token key atrule">Fn::GetAtt</span><span class="token punctuation">:</span>\n              <span class="token punctuation">-</span> SQSFailureQueue\n              <span class="token punctuation">-</span> Arn</code></pre>\n      </div>\n<ol start="4">\n<li>Attach the secondary handler to the primary one:</li>\n</ol>\n<div class="gatsby-highlight" data-language="yaml">\n      <pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">functions</span><span class="token punctuation">:</span>\n  <span class="token key atrule">primaryHandler</span><span class="token punctuation">:</span>\n    <span class="token key atrule">handler</span><span class="token punctuation">:</span> path/to/immortal<span class="token punctuation">-</span>handler.handler\n    <span class="token key atrule">name</span><span class="token punctuation">:</span> immortal<span class="token punctuation">-</span>handler\n    <span class="token key atrule">deadLetter</span><span class="token punctuation">:</span>\n      <span class="token key atrule">targetArn</span><span class="token punctuation">:</span>\n        <span class="token key atrule">GetResourceArn</span><span class="token punctuation">:</span> SQSFailureQueue</code></pre>\n      </div>\n<ol start="5">\n<li>Update IAM role statement of the service</li>\n</ol>\n<div class="gatsby-highlight" data-language="yaml">\n      <pre class="language-yaml"><code class="language-yaml">  <span class="token key atrule">iamRoleStatements</span><span class="token punctuation">:</span>\n    <span class="token punctuation">...</span>\n    <span class="token comment"># Allow running AWS Fargate containers when AWS Lambda timeout cannot be bypassed.</span>\n    <span class="token punctuation">-</span> <span class="token key atrule">Effect</span><span class="token punctuation">:</span> <span class="token string">\'Allow\'</span>\n      <span class="token key atrule">Action</span><span class="token punctuation">:</span>\n        <span class="token punctuation">-</span> ecs<span class="token punctuation">:</span>RunTask\n      <span class="token key atrule">Resource</span><span class="token punctuation">:</span> <span class="token string">\'*\'</span>\n    <span class="token punctuation">-</span> <span class="token key atrule">Effect</span><span class="token punctuation">:</span> Allow\n      <span class="token key atrule">Action</span><span class="token punctuation">:</span>\n        <span class="token punctuation">-</span> iam<span class="token punctuation">:</span>PassRole\n      <span class="token key atrule">Resource</span><span class="token punctuation">:</span>\n        <span class="token key atrule">Fn::Join</span><span class="token punctuation">:</span>\n          <span class="token punctuation">-</span> <span class="token string">\'\'</span>\n          <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token string">\'arn:aws:iam::\'</span>\n            <span class="token punctuation">-</span> <span class="token key atrule">Ref</span><span class="token punctuation">:</span> <span class="token string">\'AWS::AccountId\'</span>\n            <span class="token punctuation">-</span> <span class="token string">\':role/ecsTaskExecutionRole\'</span>\n    <span class="token comment"># ecsTaskExecutionRole is the name of the default role created by ECS,</span>\n    <span class="token punctuation">...</span>\n    <span class="token comment"># Allow queueing messages to the DLQ https://docs.aws.amazon.com/lambda/latest/dg/dlq.html</span>\n    <span class="token punctuation">-</span> <span class="token key atrule">Effect</span><span class="token punctuation">:</span> <span class="token string">\'Allow\'</span>\n      <span class="token key atrule">Action</span><span class="token punctuation">:</span>\n        <span class="token punctuation">-</span> sqs<span class="token punctuation">:</span>SendMessage\n      <span class="token key atrule">Resource</span><span class="token punctuation">:</span> <span class="token string">\'*\'</span></code></pre>\n      </div>\n<p>Details are available in <a href="https://serverless.com/blog/serverless-application-for-long-running-process-fargate-lambda/#iam-roles">the article which inspired me</a>. Keep in mind that once you <a href="https://serverless.com/framework/docs/providers/aws/guide/iam/">override defaults</a> you might need to specifiy additional permissions which are not related only to the task at hand here.</p>\n<h3 id="create-the-secondary-handler"><a href="#create-the-secondary-handler" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Create the secondary handler</h3>\n<p>Here\'s an example focused on the ECS\'s code implementation</p>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token constant">AWS</span> <span class="token keyword">from</span> <span class="token string">\'aws-sdk\'</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">const</span> handler <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>event<span class="token punctuation">,</span> context<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token comment">// Coming from environment variables setup in your `serverless.yaml` file</span>\n  <span class="token comment">// See https://serverless.com/framework/docs/providers/aws/guide/variables/#referencing-environment-variables</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">RUNNER</span><span class="token punctuation">,</span> <span class="token constant">SUBNET</span> <span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> ecs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AWS<span class="token punctuation">.</span>ECS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// Some other logic specific to your case here ...</span>\n\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> runParams <span class="token operator">=</span> <span class="token punctuation">{</span>\n      taskDefinition<span class="token punctuation">:</span> <span class="token constant">RUNNER</span><span class="token punctuation">,</span>\n      launchType<span class="token punctuation">:</span> <span class="token string">\'FARGATE\'</span><span class="token punctuation">,</span>\n      networkConfiguration<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        awsvpcConfiguration<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n          assignPublicIp<span class="token punctuation">:</span> <span class="token string">\'ENABLED\'</span><span class="token punctuation">,</span>\n          subnets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token constant">SUBNET</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      overrides<span class="token punctuation">:</span> <span class="token punctuation">{</span>\n        containerOverrides<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n          <span class="token punctuation">{</span>\n            environment<span class="token punctuation">:</span> <span class="token punctuation">[</span>\n              <span class="token punctuation">{</span>\n                name<span class="token punctuation">:</span> <span class="token string">\'AWS_LAMBDA_FUNCTION_EVENT\'</span><span class="token punctuation">,</span>\n                value<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">,</span>\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n              <span class="token comment">// Help the runner locate the handler to run inside a container.</span>\n              <span class="token punctuation">{</span>\n                name<span class="token punctuation">:</span> <span class="token string">\'AWS_LAMBDA_HANDLER_PATH\'</span><span class="token punctuation">,</span>\n                <span class="token comment">// Matches path/to/immortal-handler.handler</span>\n                value<span class="token punctuation">:</span> <span class="token string">\'path/to/immortal-handler.js\'</span><span class="token punctuation">,</span>\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n              <span class="token punctuation">{</span>\n                name<span class="token punctuation">:</span> <span class="token string">\'AWS_LAMBDA_FUNCTION_CONTEXT\'</span><span class="token punctuation">,</span>\n                value<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">,</span>\n              <span class="token punctuation">}</span><span class="token punctuation">,</span>\n              <span class="token operator">...</span>\n            <span class="token punctuation">]</span><span class="token punctuation">,</span>\n            name<span class="token punctuation">:</span> <span class="token constant">RUNNER</span><span class="token punctuation">,</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token punctuation">]</span><span class="token punctuation">,</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ecs<span class="token punctuation">.</span><span class="token function">runTask</span><span class="token punctuation">(</span>runParams<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// Returns null</span>\n    <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token keyword">export</span> <span class="token keyword">default</span> handler<span class="token punctuation">;</span></code></pre>\n      </div>\n<p>As you can notice, the most interesting part is where you pass environment variables from the secondary handler to the container.</p>\n<p>The container will take these variables and start the corresponding handler with the same <code class="language-text">event</code> and <code class="language-text">context</code>.</p>\n<h3 id="create-docker-container-and-deploy-it"><a href="#create-docker-container-and-deploy-it" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Create Docker container and deploy it</h3>\n<ol start="0">\n<li>AWS ECS setup</li>\n</ol>\n<p>Similar the <a href="https://serverless.com/blog/serverless-application-for-long-running-process-fargate-lambda/#pre-requisite-resources">prerequisites section here</a> you will need to setup the ECS task on AWS\'s console. When you use the console with the defaults, 2 new roles will be created: <code class="language-text">AWSServiceRoleForECS</code> and <code class="language-text">ecsTaskExecutionRole</code>. Use these roles and attach the necessary policy priviliges onto them depending on which resources you\'d like to manage from the container.</p>\n<p>For instance you can attach <code class="language-text">AWSLambdaFullAccess</code>, <code class="language-text">AmazonS3FullAccess</code> and <code class="language-text">AmazonECSTaskExecutionRolePolicy</code> (AWS managed policies) on <code class="language-text">ecsTaskExecutionRole</code> for a start. Later, you can limit <code class="language-text">AWSLambdaFullAccess</code> to <code class="language-text">lambda:getFunction</code> for example.</p>\n<ol>\n<li><code class="language-text">Dockerfile</code> definition</li>\n</ol>\n<p>This could be very simple, exposing 2 variable more clearly:</p>\n<div class="gatsby-highlight" data-language="text">\n      <pre class="language-text"><code class="language-text">FROM node:8\n\n# Environment variables acting as parameters of the runner.\nENV AWS_LAMBDA_FUNCTION_EVENT {}\nENV AWS_LAMBDA_FUNCTION_CONTEXT {}\n\n# Create app directory\nWORKDIR /usr/src/app\n\nCOPY . .\n\nRUN npm install\n\n# Parameters are named arguments extracted later with yargs or something else working on argv.\nCMD [&quot;sh&quot;, &quot;-c&quot;, &quot;./runner.js --event ${AWS_LAMBDA_FUNCTION_EVENT} --context ${AWS_LAMBDA_FUNCTION_CONTEXT}&quot;]</code></pre>\n      </div>\n<p>This assumes that your <code class="language-text">serverless</code> service is based on <a href="https://aws.amazon.com/blogs/compute/node-js-8-10-runtime-now-available-in-aws-lambda/">Node.js 8.10 runtime</a>.</p>\n<ol start="2">\n<li>Create a <code class="language-text">runner.js</code> file which will execute the primary handler inside the container</li>\n</ol>\n<div class="gatsby-highlight" data-language="javascript">\n      <pre class="language-javascript"><code class="language-javascript">#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node\n\n<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'path\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'https\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> <span class="token constant">AWS</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'aws-sdk\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> promisePipe <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'promisepipe\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> unzip <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'unzip\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> <span class="token punctuation">{</span> argv <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'yargs\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">const</span> runner <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">REGION</span><span class="token punctuation">,</span> <span class="token constant">AWS_LAMBDA_HANDLER_PATH</span> <span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>\n  <span class="token comment">// Required as strings by the API: https://docs.aws.amazon.com/AmazonECS/latest/APIReference/API_TaskOverride.html?shortFooter=true</span>\n  <span class="token keyword">const</span> <span class="token punctuation">{</span> event<span class="token punctuation">:</span> e<span class="token punctuation">,</span> context<span class="token punctuation">:</span> c <span class="token punctuation">}</span> <span class="token operator">=</span> argv<span class="token punctuation">;</span>\n  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> event <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>functionName<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">\'Required function name not found in context.\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">const</span> invoking <span class="token operator">=</span> context<span class="token punctuation">.</span>functionName<span class="token punctuation">;</span>\n  <span class="token comment">// Assumes dead letter queue lambda functions are suffixed with Dlq</span>\n  <span class="token keyword">const</span> originalInvoking <span class="token operator">=</span> invoking<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> invoking<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">\'Dlq\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token keyword">try</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> lambda <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AWS<span class="token punctuation">.</span>Lambda</span><span class="token punctuation">(</span><span class="token punctuation">{</span> region<span class="token punctuation">:</span> <span class="token constant">REGION</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> lambdaInfo <span class="token operator">=</span> <span class="token keyword">await</span> lambda\n      <span class="token punctuation">.</span><span class="token function">getFunction</span><span class="token punctuation">(</span><span class="token punctuation">{</span> FunctionName<span class="token punctuation">:</span> originalInvoking <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">const</span> sourceCodeSignedUrl <span class="token operator">=</span> lambdaInfo<span class="token punctuation">.</span>Code<span class="token punctuation">.</span>Location<span class="token punctuation">;</span>\n\n    <span class="token keyword">return</span> https<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>sourceCodeSignedUrl<span class="token punctuation">,</span> <span class="token keyword">async</span> res <span class="token operator">=></span> <span class="token punctuation">{</span>\n      <span class="token comment">// Download source from cloud and extract it at the current directory at the same time.</span>\n      <span class="token keyword">await</span> <span class="token function">promisePipe</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> unzip<span class="token punctuation">.</span><span class="token function">Extract</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token punctuation">:</span> __dirname <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n      <span class="token keyword">const</span> pathToHandler <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>\n        <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">AWS_LAMBDA_HANDLER_PATH</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>\n      <span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">const</span> handler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>pathToHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token comment">// Run the taget handler\'s code.</span>\n      <span class="token comment">// handler.handler is the default export of webpack\'s bundle file</span>\n      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> handler<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n<span class="token function">runner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>\n      </div>\n<p>Don\'t forget to make this file executable:</p>\n<div class="gatsby-highlight" data-language="sh">\n      <pre class="language-sh"><code class="language-sh">$ chmod +x runner.js</code></pre>\n      </div>\n<ol start="3">\n<li>Create a repository for the image on ECS</li>\n</ol>\n<p>The process is similar to creating a repository on Github. Check this <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ECS_Console_Repositories.html">documentation</a> for having an idea about it.</p>\n<ol start="4">\n<li>Build the image</li>\n</ol>\n<div class="gatsby-highlight" data-language="sh">\n      <pre class="language-sh"><code class="language-sh">$ docker build -t runner .</code></pre>\n      </div>\n<ol start="5">\n<li>Tag it</li>\n</ol>\n<div class="gatsby-highlight" data-language="sh">\n      <pre class="language-sh"><code class="language-sh">$ docker tag runner:latest {accountId}.dkr.ecr.eu-central-1.amazonaws.com/runner:latest</code></pre>\n      </div>\n<p>You\'d normally get the information about the tag when you have created the repository at ECS.</p>\n<p>For more details on tagging the image, see this <a href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/docker-push-ecr-image.html">tutorial</a>.</p>\n<ol start="6">\n<li>Push the latest image to the repository</li>\n</ol>\n<div class="gatsby-highlight" data-language="sh">\n      <pre class="language-sh"><code class="language-sh">$ docker push {accountId}.dkr.ecr.eu-central-1.amazonaws.com/runner:latest</code></pre>\n      </div>\n<p>If you experience issues with credentials, you can run the following command to re-take temporary credentials and use them directly without copy-paste:</p>\n<div class="gatsby-highlight" data-language="text">\n      <pre class="language-text"><code class="language-text">$ aws ecr get-login --no-include-email | source /dev/stdin</code></pre>\n      </div>\n<p>At this point, if you have configured your ECS task to use this container from this repository, running the container will run the <code class="language-text">runner.js</code> which on its part will run the primary handler.</p>\n<h2 id="win"><a href="#win" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Win</h2>\n<p>Now you have a setup where:</p>\n<ul>\n<li>Primary lambda function can possibly fail because of a timeout issue.</li>\n<li>A secondary lambda function gets triggered with initial <code class="language-text">event</code> and <code class="language-text">context</code> from the primary.</li>\n<li>Secondary lambda function starts a docker container on Fargate with these <code class="language-text">event</code> and <code class="language-text">context</code> and adds some more information about the location of the handler to run in the container.</li>\n<li>The container\'s <code class="language-text">runner.js</code> gets executed without any timeout limitations and runs the primary lambda function for as long as it\'s necessary for the process to complete successfully.</li>\n</ul>'
}},pathContext:{slug:"solving-aws-lambda-timeouts-fargate"}}}});
//# sourceMappingURL=path---solving-aws-lambda-timeouts-fargate-62901aa26a576639929f.js.map